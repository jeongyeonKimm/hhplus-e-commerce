# 가상 장애 대응 문서

## 1. 가상 장애 시나리오
| 시나리오                    | 원인                                                                 | 영향                                                                                 | 심각도 |
|----------------------------|----------------------------------------------------------------------|--------------------------------------------------------------------------------------|--------|
| **응답 시간 급증**           | • Redis 락 경합<br>• Kafka 메시지 처리 지연<br>• GC Pause 발생<br>• DB 커넥션 풀 포화 | • 사용자 응답 지연<br>• 일부 요청 타임아웃<br>• SNS 등에서 부정적 사용자 피드백 발생 가능 | 높음   |
| **Kafka 메시지 처리 지연**   | • Kafka consumer 인스턴스 부족<br>• 파티션 수 미흡<br>• Consumer 내부 처리 병목<br>• Kafka lag 누적 | • 쿠폰 발급 요청은 접수되나 처리 지연<br>• Kafka 큐 적체<br>• 발급 완료 상태와 실제 처리 불일치 가능 | 심각   |
| **DB 커넥션 풀 고갈**        | • 커넥션 누수<br>• 트랜잭션 과도 유지<br>• 동시에 수천 건의 요청 발생<br>• Long-running 쿼리 존재 | • DB 연결 실패로 500 에러 다수 발생<br>• Kafka 메시지 처리 실패<br>• 전체 API 응답 지연 또는 중단 | 심각   |
| **Redis 락 경합 심화**       | • 다수의 동시 사용자 쿠폰 요청<br>• 락 점유 시간 과도<br>• 락 해제 지연 또는 재시도 충돌 | • API 처리 속도 저하<br>• 응답 시간 증가<br>• 서버 CPU 사용률 상승                        | 중간   |
| **GC 일시 정지 (STW)**       | • Kafka 메시지 대량 처리 중 객체 생성 폭증<br>• GC 튜닝 미흡<br>• Old Generation 영역 과도 사용 | • 일시적 응답 시간 급증<br>• Kafka consumer 일시 정지<br>• 병목 구간 확대                   | 중간   |

## 2. 장애 대응 프로세스
| 단계               | 활동               | 세부 내용                                                                                                                                  | 시간 프레임          |
|--------------------|--------------------|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------|
| **1. 장애 감지 및 경보** | 모니터링 트리거     | • Kafka lag > 1000: 경고<br>• 응답 시간 > 2초: 경고, > 4초: 심각 경보<br>• DB 커넥션 풀 사용률 > 90%: 경고<br>• CPU 사용률 > 85%: 경고 | 실시간                |
|                    | 알림 체계           | • 1차 온콜 엔지니어(L1) 알림<br>• 30분 이상 지속 시 2차 책임자(L2) 에스컬레이션<br>• 1시간 이상 지속 시 전체 운영팀 긴급 호출        | 경보 후 5분 이내      |
| **2. 초기 대응**       | 서비스 차단 및 제한  | • 발급 API에 Rate Limit 적용<br>• Kafka consumer 재시작 또는 일시 확장<br>• DB 커넥션 풀 증설 또는 부하 분산                            | 감지 후 10분 이내     |
|                    | 상태 페이지 활성화  | • 사용자 대기 화면 전환<br>• “쿠폰 발급 지연 중” 안내 공지<br>• 트래픽 분산을 위한 안내 메시지 출력                                   | 감지 후 15분 이내     |
| **3. 장애 분석**       | 실시간 로그 분석     | • Kafka consumer 로그에서 lag, exception, 재시도 이슈 파악<br>• Redis 락 획득 실패 로그 수집<br>• DB Deadlock 로그, 커넥션 풀 상태 확인 | 감지 후 15~30분       |
|                    | 성능 지표 수집      | • Prometheus에서 Kafka lag, GC 시간, Redis lock 획득 시간 추출<br>• JVM heap dump 분석<br>• DB active connection 수 및 slow query 로그 수집 | 감지 후 20~40분       |
|                    | 근본 원인 분석      | • 병목 구간 구체화 (Kafka vs DB vs GC)<br>• 재현 경로 및 트래픽 분포 분석<br>• 코드 및 인프라 설정 검토                              | 감지 후 30~60분       |
| **4. 커뮤니케이션**    | 내부 소통           | • 장애 대응 Slack 채널 실시간 브리핑<br>• 대응팀 Zoom 회의 즉시 개설<br>• QA/기획팀 상황 공유                                          | 감지 후 지속적        |
|                    | 외부 소통           | • 30분 간격 상태 페이지 업데이트<br>• 고객센터 응대 매뉴얼 전파<br>• SNS 채널로 공지 발송 (필요 시)                                     | 감지 후 30분 간격     |
| **5. 복구 실행**       | 임시 조치 적용       | • Kafka consumer 인스턴스 수 확장<br>• 락 경합 시 Lua script 재정의<br>• GC 튜닝 적용 및 힙 크기 조정<br>• DB 읽기 replica로 일부 offload | 분석 완료 즉시        |
|                    | 효과 모니터링       | • 조치 이후 응답 시간, Kafka lag, DB 커넥션 풀 정상화 여부 확인<br>• 에러율, CPU/RAM 사용률 지속 추적                                | 조치 후 지속적        |
| **6. 사후 분석**       | 회고 미팅           | • 대응팀 전원 참석 회고<br>• 타임라인 기반 장애 대응 프로세스 검토<br>• 모니터링 미비점, 자동화 부족 등 개선 항목 도출                | 복구 후 24시간 이내   |
|                    | 재발 방지 계획      | • Kafka 파티션 및 consumer 구조 리팩토링<br>• Redis 락 범위 최소화 및 분산 키 설계<br>• GC 튜닝 가이드 문서화 및 사전 부하 테스트 확대 | 복구 후 1주일 이내    |
